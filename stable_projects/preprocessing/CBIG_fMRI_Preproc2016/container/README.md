# Containerized CBIG_fMRI_Preproc2016

If you are a user trying to run the containerized CBIG 2016 fMRI preprocessing pipeline, please refer to the [User Guides](#user-guide-using-a-lightweight-wrapper-recommended). Please note that the containers are not tested on Windows and Mac. If you encounter any issues on these two platforms, please create an issue on the [CBIG GitHub repository](https://github.com/ThomasYeoLab/CBIG)

If you are a developer trying to improve the containerization script, please refer to the [Developer Guide](README_DEV.md).

## Introduction to Containerization Technologies

> This section contains brief introductions to containerization technologies. If you are familiar with them, you may skip this section.

Containerization is a lightweight form of virtualization that allows developers to package applications and their dependencies into containers, ensuring that the application runs seamlessly in any environment. Two popular containerization platforms are Docker and Singularity.

### Key Containerization Concepts

-   **Image**:
    An image is a portable, standalone file that includes everything needed to run a software application: code, runtime, libraries, and configuration files. It serves as a blueprint for creating containers.
-   **Container**:
    A container is a runnable instance of an image. Containers run processes in isolation from the host system and each other, ensuring consistent application behavior across environments.
-   **Host**:
    The machine on which the container runs.
-   **Docker Volume**:
    Volumes in Docker are used to persist data generated by and used by Docker containers. They are used to share data between the host and Docker containers.
-   **Singularity Bind Mount**:
    Similar to Docker Volume, Bind mounts in Singularity are used to mount directories from the host to the container, allowing data to be shared between the host and the container.

## Before you start

### Install MATLAB Compiler Runtime (MCR)

Please download and install the MATLAB Compiler Runtime (MCR) R2018b (version 9.5) from the [official MathWorks website](https://www.mathworks.com/products/compiler/matlab-runtime.html). Take note of the installation directory of the MCR, as you will need it later.

### Install Docker (for Docker version)

Please follow the Docker's [official installation guide](https://docs.docker.com/get-docker/) to install Docker on your machine. To verify that Docker is installed correctly, run the following command:

```
docker run --rm hello-world
```

If you see the message `Hello from Docker!`, then Docker is installed correctly.

### Install Singularity (for Singularity version)

> **Note**: If you have installed Singularity but its version is less than version 2.5, please install newer version of Singularity.

Please follow the Singularity's [official installation guide](https://docs.sylabs.io/guides/3.11/user-guide/quick_start.html#quick-installation-steps) to install Singularity on your machine.

### Prepare Input and Output Directories

Please create directories on your host machine to store the input data and output results. You will need to mount these directories to the container (either via Docker Volume or Singularity Bind Mount) when running the CBIG 2016 fMRI preprocessing pipeline.

## User Guide using a Lightweight Wrapper (Recommended)

We have created a lightweight wrapper script `CBIG_preproc_run_container.sh` for your convenience. This wrapper will:

-   allow you to specify the containerization technology to run (docker or singularity)
-   create the output directory if it does not exist
-   pull the docker image from Docker Hub
-   convert the Docker image to Singularity image (when using Singularity)
-   generate Docker/Singularity commands for you
-   print out the generated Docker/Singularity commands
-   execute the Docker/Singularity commands

### Read the Help Text

Please carefully check the help texts of both the wrapper (`CBIG_preproc_run_container.sh`) and the main preprocessing script (`CBIG_preproc_fMRI_preprocess.csh`) before running any commands.

You can check the help text of the wrapper (`CBIG_preproc_run_container.sh`) by running the following command:

```
./CBIG_preproc_run_container.sh --help
```

You can check the help text of the main preprocessing script (`CBIG_preproc_fMRI_preprocess.csh`) by running the following command:

```
./CBIG_preproc_run_container.sh --main-help
```

Make sure that you have familiarized yourself with the required and optional arguments before running the pipeline.

### Run the lightweight wrapper

To run the wrapper, simply run the following command:

```
./CBIG_preproc_run_container.sh \
--container <container_type> \
--mcr <path_to_MATLAB_Compiler_Runtime> \
--input <path_to_input> \
--out <path_to_output> \
[Arguments to the Main Preprocessing Script]
```

**Line-by-line explanation**:

-   `CBIG_preproc_run_container.sh`: The lightweight wrapper.
-   `--container <container_type>`: Specify the containerization technology to use (either `docker` or `singularity`).
-   `--mcr <path_to_MATLAB_Compiler_Runtime>`: Specify the installation directory of the MATLAB Compiler Runtime (MCR) R2018b.
-   `--input <path_to_input>`: Specify the directory containing the input data, fmrinii, and config file.
-   `--out <path_to_output>`: Specify the directory where the output results will be stored.
-   `[Arguments to the Main Preprocessing Script]`: Additional arguments to the main preprocessing script (`CBIG_preproc_fMRI_preprocess.csh`). Please check to the help text of the main preprocessing script using commands in the previous subsection. Note that there is no need to specify the output directory (`-output_d` option for the Main Preprocessing Script) as it will be automatically set to `/out` by the wrapper. This `/out` directory within the container will then connect to your specified `<path_to_output>` on your host machine and the output files will appear in the `<path_to_output>`. Moreover, arguments `-anat_d`, `-fmrinii`, and `-config` should be `/input/` followed by their relative paths to `<path_to_input>`. For example, if you store the FreeSurfer recon-all folder in `<path_to_input>/data`, then `<anat_dir>` should be `/input/data`.

**Docker Example:**

```
${CBIG_CODE_DIR}/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/container/CBIG_preproc_run_container.sh \
--container docker \
--mcr /apps/matlab/MATLAB_Compiler_Runtime/v95 \
--input $CBIG_TESTDATA_DIR/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/single_subject \
--out ${CBIG_CODE_DIR}/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/container/tmp/docker_out \
-s sub005 \
-anat_s sub005_FS \
-anat_d /input/data \
-fmrinii /input/docker/sub005_docker.fmrinii \
-config /input/docker/prepro_docker.config \
-nocleanup
```

**Singularity Example:**

If you are running the pipeline using Singularity, you may specify the directory to store the Singularity image using the `-sdir` flag before `[Arguments to the Main Preprocessing Script]` (by default the Singularity image is stored under the `$HOME` directory). For example:

```
${CBIG_CODE_DIR}/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/container/CBIG_preproc_run_container.sh --container singularity \
--mcr /apps/matlab/MATLAB_Compiler_Runtime/v95 \
--input $CBIG_TESTDATA_DIR/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/single_subject \
--out ${CBIG_CODE_DIR}/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/container/tmp/singularity_out \
-sdir ${CBIG_CODE_DIR}/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/container/tmp/ \
-s sub005 \
-anat_s sub005_FS \
-anat_d /input/data \
-fmrinii /input/docker/sub005_docker.fmrinii \
-config /input/docker/prepro_docker.config \
-nocleanup
```

## User Guide for Docker Version

### Pull the Docker Image

To pull the latest version of the containerized CBIG 2016 fMRI preprocessing pipeline, run the following command:

```
docker pull thomasyeolab/cbig_fmri_preproc2016:latest
```

If you want to pull a specific version of the docker image, replace `latest` with the version number. For example, to pull version `v1.0.1`, run:

```
docker pull thomasyeolab/cbig_fmri_preproc2016:v1.0.1
```

### Read the Help Text

Once you have pulled the Docker image, you can check the help text by running the following command:

```
docker run -it --rm thomasyeolab/cbig_fmri_preproc2016:latest
```

Make sure that you have familiarized yourself with the required and optional arguments before running the pipeline.

### Run the Dockerized CBIG fMRI Preprocessing Pipeline

To run the pipeline, you will need to put your input data, fmrinii, and config file in the input directory that you have [previously created](#prepare-input-and-output-directories).

Then, you can run the CBIG 2016 fMRI preprocessing pipeline using the following command:

```
docker run -it --rm \
-u $(id -u):$(id -g) -e HOME=$HOME \
-v <path_to_MATLAB_Compiler_Runtime>:/apps/matlab/MCR_R2018b/v95:ro \
-v <path_to_input>:/input:ro \
-v <path_to_output>:/out \
thomasyeolab/cbig_fmri_preproc2016:latest \
-output_d /out -s <subject> -anat_s <anat> \
-anat_d /input/<anat_dir> \
-fmrinii /input/<fmrinii> \
-config /input/<config>
...
```

**Line-by-line explanation**:

-   `docker run -it --rm`: Command to run the container.
-   `-u $(id -u):$(id -g) -e HOME=$HOME`: run the container as your current user. Note that if you did not specify the `-u` flag, the output files will be owned by `root`, which may cause permission issues when you want to move or delete those files.
-   `-v <path_on_host>:<path_in_container>:ro`: Mounts the host directory `<path_on_host>` to the container. The directory will appear in the container as `<path_in_container>`. The optional `ro` flag makes the directory read-only to avoid accidental modifications.
-   `thomasyeolab/cbig_fmri_preproc2016:latest`: The name of the Docker image to run.
-   `-output_d /out`: The output directory is set to `/out` **in the container**, which corresponds to `<path_to_output>` **on the host**. Please DO NOT change `/out` to other directory as you have mounted `<path_to_output>` to `/out`.
-   `-s <subject>`: Subject ID.
-   `-anat_s <anat>`: FreeSurfer recon-all folder name of this subject (relative path).
-   `-anat_d /input/<anat_dir>`: Specify anat directory to recon-all folder, i.e. `/input/<anat_dir>` contains `<anat>`. Note that `<anat_dir>` is relative to `<path_to_input>`. For example, if you store the FreeSurfer recon-all folder in `<path_to_input>/data`, then `<anat_dir>` should be `data`.
-   `-fmrinii /input/<fmrinii>`: Specify the fmrinii (please check the help text for detailed description of fmrinii). `<fmrinii>` is relative to `<path_to_input>`.
-   `-config /input/<config>`: Specify the config file. Again, `<config>` is relative to `<path_to_input>`.
-   For other optional arguments to the main preprocessing script, please check the help text using the command in the previous subsection.

**Example:**

```
docker run -it --rm \
-u $(id -u):$(id -g) -e HOME=$HOME \
-v /apps/matlab/MATLAB_Compiler_Runtime/v95:/apps/matlab/MCR_R2018b/v95:ro \
-v $CBIG_TESTDATA_DIR/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/single_subject:/input:ro \
-v ${CBIG_CODE_DIR}/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/container/tmp/docker_out:/out \
thomasyeolab/cbig_fmri_preproc2016:latest \
-output_d /out -s sub005 -anat_s sub005_FS \
-anat_d /input/data \
-fmrinii /input/docker/sub005_docker.fmrinii \
-config /input/docker/prepro_docker.config \
-nocleanup
```

#### Run the Dockerized CBIG fMRI Preprocessing Pipeline within the Container

If you prefer to run the pipeline within the container (e.g., for debugging purposes), you can first use the following command to enter the container:

```
docker run -it --rm \
-u $(id -u):$(id -g) -e HOME=$HOME \
-v <path_to_MATLAB_Compiler_Runtime>:/apps/matlab/MCR_R2018b/v95:ro \
-v <path_to_input>:/input:ro \
-v <path_to_output>:/out \
--entrypoint /bin/bash \
thomasyeolab/cbig_fmri_preproc2016:latest
```

**Example:**

```
docker run -it --rm \
-u $(id -u):$(id -g) -e HOME=$HOME \
-v /apps/matlab/MATLAB_Compiler_Runtime/v95:/apps/matlab/MCR_R2018b/v95:ro \
-v $CBIG_TESTDATA_DIR/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/single_subject:/input:ro \
-v ${CBIG_CODE_DIR}/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/container/tmp/docker_out:/out \
--entrypoint /bin/bash \
thomasyeolab/cbig_fmri_preproc2016:latest
```

Then you can run the pipeline within the container using the following command:

```
csh CBIG_preproc_fMRI_preprocess.csh \
-output_d /out -s <subject> -anat_s <anat> \
-anat_d /input/<anat_dir> \
-fmrinii /input/<fmrinii> \
-config /input/<config>
...
```

## User Guide for Singularity Version

In many HPC environments, Docker is not supported due to security concerns. In such cases, Singularity can be used as an alternative to run the containerized CBIG 2016 fMRI preprocessing pipeline.

### Convert Docker Image to Singularity Image

First, you need to create a Singularity image from the Docker image. You can do this by running the following command:

```
singularity build --sandbox cbig_fmri_preproc2016 docker://thomasyeolab/cbig_fmri_preproc2016:latest
```

This will get the `thomasyeolab/cbig_fmri_preproc2016` image from the Docker Hub and subsequently convert the pulled docker image to a Singularity image `cbig_fmri_preproc2016` in your current directory.

### Read the Help Text

Once you have created the Singularity image, you can check the help text by running the following command:

```
singularity run --cleanenv cbig_fmri_preproc2016
```

Make sure that you have familiarized yourself with the required and optional arguments before running the pipeline.

### Run the Singularity version CBIG fMRI Preprocessing Pipeline

To run the pipeline, you will need to put your input data, fmrinii, and config file in the input directory that you have [previously created](#prepare-input-and-output-directories).

Then, you can run the CBIG 2016 fMRI preprocessing pipeline using the following command:

```
singularity run --cleanenv --no-home --writable \
-B <path_to_MATLAB_Compiler_Runtime>:/apps/matlab/MCR_R2018b/v95:ro \
-B <path_to_input>:/input:ro \
-B <path_to_output>:/out \
cbig_fmri_preproc2016 \
-output_d /out -s <subject> -anat_s <anat> \
-anat_d /input/<anat_dir> \
-fmrinii /input/<fmrinii> \
-config /input/<config>
...
```

**Line-by-line explanation**:

-   `singularity run --cleanenv --no-home --writable`: Command to run the container.
-   `-B <path_on_host>:<path_in_container>:ro`: Mounts the host directory `<path_on_host>` to the container. The directory will appear in the container as `<path_in_container>`. The optional `ro` flag makes the directory read-only to avoid accidental modifications.
-   `cbig_fmri_preproc2016`: The name of the Singularity image to run.
-   `-output_d /out`: The output directory is set to `/out` **in the container**, which corresponds to `<path_to_output>` **on the host**. Please DO NOT change `/out` to other directory as you have mounted `<path_to_output>` to `/out`.
-   `-s <subject>`: Subject ID.
-   `-anat_s <anat>`: FreeSurfer recon-all folder name of this subject (relative path).
-   `-anat_d /input/<anat_dir>`: Specify anat directory to recon-all folder, i.e. `/input/<anat_dir>` contains `<anat>`. Note that `<anat_dir>` is relative to `<path_to_input>`. For example, if you store the FreeSurfer recon-all folder in `<path_to_input>/data`, then `<anat_dir>` should be `data`.
-   `-fmrinii /input/<fmrinii>`: Specify the fmrinii (please check the help text for detailed description of fmrinii). `<fmrinii>` is relative to `<path_to_input>`.
-   `-config /input/<config>`: Specify the config file. Again, `<config>` is relative to `<path_to_input>`.
-   For other optional arguments to the main preprocessing script, please check the help text using the command in the previous subsection.

**Example:**

```
singularity run --cleanenv --no-home --writable \
-B /apps/matlab/MATLAB_Compiler_Runtime/v95:/apps/matlab/MCR_R2018b/v95:ro \
-B $CBIG_TESTDATA_DIR/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/single_subject:/input:ro \
-B ${CBIG_CODE_DIR}/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/container/tmp/singularity_out:/out \
cbig_fmri_preproc2016 \
-output_d /out -s sub005 -anat_s sub005_FS \
-anat_d /input/data \
-fmrinii /input/docker/sub005_docker.fmrinii \
-config /input/docker/prepro_docker.config \
-nocleanup
```

#### Run the Singularity version CBIG fMRI Preprocessing Pipeline within the Container

If you prefer to run the pipeline within the container (e.g., for debugging purposes), you can first use the following command to enter the container:

```
singularity shell --cleanenv --no-home --writable \
-B <path_to_MATLAB_Compiler_Runtime>:/apps/matlab/MCR_R2018b/v95:ro \
-B <path_to_input>:/input:ro \
-B <path_to_output>:/out \
cbig_fmri_preproc2016
```

**Example:**

```
singularity shell --cleanenv --no-home --writable \
-B /apps/matlab/MATLAB_Compiler_Runtime/v95:/apps/matlab/MCR_R2018b/v95:ro \
-B $CBIG_TESTDATA_DIR/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/single_subject:/input:ro \
-B ${CBIG_CODE_DIR}/stable_projects/preprocessing/CBIG_fMRI_Preproc2016/container/tmp/singularity_out:/out \
cbig_fmri_preproc2016
```

Once inside the container, run the following command to setup the environment:

```
source /app/setup/CBIG_config_in_container.sh
```

Then you can run the pipeline within the container using the following command:

```
cd /app/CBIG_private/stable_projects/preprocessing/CBIG_fMRI_Preproc2016 && csh CBIG_preproc_fMRI_preprocess.csh \
-output_d /out -s <subject> -anat_s <anat> \
-anat_d /input/<anat_dir> \
-fmrinii /input/<fmrinii> \
-config /input/<config>
...
```
